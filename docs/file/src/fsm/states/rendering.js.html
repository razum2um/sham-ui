<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/fsm/states/rendering.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DI.js~DI.html">DI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/shamUI.js~ShamUI.html">ShamUI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/widget.js~Widget.html">Widget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-inject">inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DI">DI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Fsm">Fsm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FsmState">FsmState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FsmStates">FsmStates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Widget">Widget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-inject">inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-options">options</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-options">options</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">fsm</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fsm/fsm.js~FSM.html">FSM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-states">states</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">fsm/states</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fsm/states/ready.js~ReadyState.html">ReadyState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fsm/states/registration.js~RegistrationState.html">RegistrationState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fsm/states/rendering.js~RenderingState.html">RenderingState</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/fsm.js~Fsm.html">Fsm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/fsm.js~State.html">State</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/fsm/states/rendering.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { State } from &apos;../../utils/fsm&apos;;

/**
 * @classdesc Deferred &#x43D;&#x430; &#x43D;&#x430;&#x442;&#x438;&#x432;&#x43D;&#x44B;&#x445; Promise
 * todo: move to utils?
 * @returns {*}
 * @constructor
 * @class Deferred
 */
function Deferred() {
    this.promise = new Promise( function( resolve, reject ) {
        this.resolve = resolve;
        this.reject = reject;
    }.bind( this ) );
    return this;
}

/**
 * &#x41A;&#x43B;&#x430;&#x441;&#x441; &#x434;&#x43B;&#x44F; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x44F; &quot;&#x41E;&#x442;&#x440;&#x438;&#x441;&#x43E;&#x432;&#x44B;&#x432;&#x430;&#x435;&#x43C; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x44B;&quot;
 */
export default class RenderingState extends State {
    /**
     * &#x427;&#x442;&#x43E; &#x434;&#x435;&#x43B;&#x430;&#x442;&#x44C; &#x441; &#x43D;&#x435;&#x43E;&#x431;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x435;&#x43C;&#x44B;&#x43C;&#x438; &#x432; &#x44D;&#x442;&#x43E;&#x43C; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x44F; &#x445;&#x44D;&#x43D;&#x434;&#x43B;&#x435;&#x440;&#x44B;
     */
    _anyEvents() {
        this.deferUntilTransition();
    }

    /**
     * &#x412;&#x44B;&#x437;&#x44B;&#x432;&#x430;&#x435;&#x442;&#x441;&#x44F; &#x43F;&#x440;&#x438; &#x432;&#x445;&#x43E;&#x434;&#x435; &#x432; &#x44D;&#x442;&#x43E; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x435;
     */
    _onEnter() {
        let self = this,
            promises = [],
            promiseById = {},
            widgetDependencePromise;

        this.cmpWidget = function( a, b ) {
            const indexA = self._fsm.idArray.indexOf( a ),
                indexB = self._fsm.idArray.indexOf( b );
            if ( indexA &gt; indexB ) {
                return 1;
            } else if ( indexA &lt; indexB ) {
                return -1;
            } else {
                return 0;
            }
        };

        // &#x421;&#x43E;&#x440;&#x442;&#x438;&#x440;&#x443;&#x435;&#x43C; &#x43F;&#x43E; renderDependence
        this._fsm.changeWidgets.sort( function( a, b ) {
            const widgetARD = self._fsm.byId[ a ].options.renderDependence,
                widgetBRD = self._fsm.byId[ b ].options.renderDependence;
            if ( !widgetARD || !widgetARD.length ) {
                if ( !widgetBRD || !widgetBRD.length ) {

                    // &#x423; &#x43E;&#x431;&#x43E;&#x438;&#x445; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x43E;&#x432; &#x43D;&#x435;&#x442; &#x437;&#x430;&#x432;&#x438;&#x441;&#x438;&#x43C;&#x43E;&#x441;&#x442;&#x435;&#x439;
                    return self.cmpWidget( a, b );
                } else {

                    // &#x417;&#x430;&#x432;&#x438;&#x441;&#x438;&#x442; &#x43B;&#x438; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442; B &#x43E;&#x442; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x430; A
                    return widgetBRD.indexOf( a ) !== -1 ? -1 : self.cmpWidget( a, b );
                }
            } else {
                if ( !widgetBRD || !widgetBRD.length ) {

                    // &#x417;&#x430;&#x432;&#x438;&#x441;&#x438;&#x442; &#x43B;&#x438; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442; A &#x43E;&#x442; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x430; B
                    return widgetARD.indexOf( b ) !== -1 ? 1 : self.cmpWidget( a, b );
                } else {

                    // &#x423; &#x43E;&#x431;&#x43E;&#x438;&#x445; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x43E;&#x432; &#x435;&#x441;&#x442;&#x44C; &#x437;&#x430;&#x432;&#x438;&#x441;&#x438;&#x43C;&#x43E;&#x441;&#x442;&#x438;
                    if ( widgetARD.indexOf( b ) !== -1 ) {

                        // &#x412;&#x438;&#x434;&#x436;&#x435;&#x442; A &#x437;&#x430;&#x432;&#x438;&#x441;&#x438;&#x442; &#x43E;&#x442; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x430; B
                        return 1;
                    } else if ( widgetBRD.indexOf( a ) !== -1 ) {

                        // &#x412;&#x438;&#x434;&#x436;&#x435;&#x442; B &#x437;&#x430;&#x432;&#x438;&#x441;&#x438;&#x442; &#x43E;&#x442; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x430; A
                        return -1;
                    } else {

                        // &#x412;&#x438;&#x434;&#x436;&#x435;&#x442;&#x44B; &#x43D;&#x435; &#x437;&#x430;&#x432;&#x438;&#x441;&#x44F;&#x442; &#x434;&#x440;&#x443;&#x433; &#x43E;&#x442; &#x434;&#x440;&#x443;&#x433;&#x430;
                        return self.cmpWidget( a, b );
                    }
                }
            }
        } );

        this.rendered = [];

        for ( let i = 0; i &lt; this._fsm.changeWidgets.length; i++ ) {
            let current = this._fsm.byId[ this._fsm.changeWidgets[ i ] ];
            if ( current &amp;&amp; current.render ) {
                if ( !current.options.conditionRender ||
                    current.options.conditionRender() ) {
                    const deferred = new Deferred();
                    promises.push( deferred.promise );
                    promiseById[ this._fsm.changeWidgets[ i ] ] = deferred.promise;

                    if ( current.options.renderDependence &amp;&amp;
                        current.options.renderDependence.length ) {
                        widgetDependencePromise = new Array(
                            current.options.renderDependence.length
                        );
                        for ( let j = 0; j &lt; current.options.renderDependence.length; j++ ) {
                            widgetDependencePromise[ j ] = promiseById[
                                current.options.renderDependence[ j ]
                                ];
                        }
                    } else {
                        widgetDependencePromise = [];
                    }

                    ( function( widget, widgetDependencePromise, deferred ) {

                        // &#x41E;&#x442;&#x440;&#x438;&#x441;&#x43E;&#x432;&#x44B;&#x432;&#x430;&#x435;&#x43C; &#x44D;&#x442;&#x43E;&#x442; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442; &#x442;&#x43E;&#x43B;&#x44C;&#x43A;&#x43E; &#x43F;&#x43E;&#x441;&#x43B;&#x435; &#x442;&#x43E;&#x433;&#x43E;, &#x43A;&#x430;&#x43A;
                        // &#x432;&#x441;&#x435; &#x437;&#x430;&#x432;&#x438;&#x441;&#x438;&#x43C;&#x43E;&#x441;&#x442;&#x438; &#x43E;&#x442;&#x440;&#x438;&#x441;&#x43E;&#x432;&#x430;&#x43B;&#x438;&#x441;&#x44C;
                        Promise.all( widgetDependencePromise )
                            .then( function() {
                                if ( widget.options.renderAsync ) {
                                    widget.options.renderAsyncWrapper(
                                        function() {
                                            self.handle( &quot;renderWidget&quot;, widget, deferred );
                                        }
                                    );
                                } else {
                                    self.handle( &quot;renderWidget&quot;, widget, deferred );
                                }
                            }, self.handleException.bind( self ) );
                    } )( current, widgetDependencePromise, deferred );
                }
            }
        }

        Promise.all( promises ).then( function() {
            // &#x412;&#x441;&#x435; &#x43E;&#x431;&#x43B;&#x430;&#x441;&#x442;&#x438; &#x43E;&#x442;&#x440;&#x438;&#x441;&#x43E;&#x432;&#x430;&#x43B;&#x438;&#x441;&#x44C;
            promiseById = null;

            // &#x422;&#x430;&#x43A; &#x436;&#x435; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x435;&#x43C; &#x43F;&#x43E; &#x43E;&#x442;&#x434;&#x435;&#x43B;&#x44C;&#x43D;&#x43E;&#x441;&#x442;&#x438;
            for ( let i = 0; i &lt; self.rendered.length; i++ ) {
                self.emit( [
                               &quot;RenderComplete[&quot;, self.rendered[ i ], &quot;]&quot;
                           ].join( &quot;&quot; ) );
            }

            // &#x418; &#x432;&#x441;&#x435; &#x441;&#x440;&#x430;&#x437;&#x443;
            self.emit( &quot;RenderComplete&quot;, self.rendered );
            self.transition( &quot;ready&quot; );
        }, this.handleException.bind( this ) );
    }

    /**
     * &#x412;&#x44B;&#x437;&#x44B;&#x432;&#x430;&#x435;&#x442;&#x441;&#x44F; &#x43F;&#x440;&#x438; &#x432;&#x44B;&#x445;&#x43E;&#x434;&#x435; &#x438;&#x437; &#x44D;&#x442;&#x43E;&#x433;&#x43E; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;
     */
    _onExit() {
        this.rendered = [];
        this._fsm.changeWidgets = [];
    }

    /**
     * &#x41E;&#x442;&#x440;&#x438;&#x441;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x43E;&#x434;&#x438;&#x43D; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;
     * @param {Object} widget   &#x412;&#x438;&#x434;&#x436;&#x435;&#x442;
     * @param {Object} deferred &#x41E;&#x442;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x43D;&#x44B;&#x439; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442; &#x434;&#x43B;&#x44F; &#x44D;&#x442;&#x43E;&#x433;&#x43E; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x430;
     * @see Widget
     */
    renderWidget( widget, deferred ) {
        if ( widget.options.beforeRender ) {
            widget.options.beforeRender.call( widget );
        }
        this.rendered.push( widget.ID );

        new Promise( ( resolve ) =&gt; {
            const obj = widget.render();
            if ( !obj ) {
                resolve();
                return;
            }
            if ( obj.html ) {
                const newEl = obj.container.cloneNode( false );
                newEl.innerHTML = obj.html;
                obj.container.parentNode.replaceChild( newEl, obj.container );
                widget.container = newEl;
                resolve();
            }

        } ).then( () =&gt; {
            if ( widget.options.afterRender ) {
                widget.options.afterRender.call( widget );
            }
            if ( widget.options.actionSequence[ 0 ] === &quot;render&quot; &amp;&amp;
                widget.bindEvents &amp;&amp; !widget.isBinded ) {

                // &#x415;&#x441;&#x43B;&#x438; &#x43F;&#x43E;&#x441;&#x43B;&#x435; &#x43E;&#x442;&#x440;&#x438;&#x441;&#x43E;&#x432;&#x43A;&#x438; &#x43D;&#x443;&#x436;&#x43D;&#x43E; &#x431;&#x438;&#x43D;&#x434;&#x438;&#x442;&#x44C; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x438; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x439; &#x432;&#x438;&#x434;&#x436;&#x435;&#x442;&#x430; &#x438;&#x43B;&#x438; &#x43D;&#x435;&#x442;
                if ( widget.options.beforeBindEvents ) {
                    widget.options.beforeBindEvents.call( widget );
                }
                widget.bindEvents();
                if ( widget.options.afterBindEvents ) {
                    widget.options.afterBindEvents.call( widget );
                }
                if ( widget.options.bindOnce ) {
                    widget.isBinded = true;
                }
            }
            deferred.resolve();
        } ).catch( this.handleException.bind( this ) );
    }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
